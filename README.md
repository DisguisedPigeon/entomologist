# Entomologist

[![Package Version](https://img.shields.io/hexpm/v/entomologist)](https://hex.pm/packages/entomologist)
[![Hex Docs](https://img.shields.io/badge/hex-docs-ffaff3)](https://hexdocs.pm/entomologist/)

## Roadmap
- [x] [Basic exception handling and storage](https://github.com/DisguisedPigeon/entomologist/issues/1)
- [ ] [Minimal Frontend](https://github.com/DisguisedPigeon/entomologist/issues/2)
- [ ] [Exception tagging on the backend](https://github.com/DisguisedPigeon/entomologist/issues/3)
- [ ] [Exception tagging on the frontend](https://github.com/DisguisedPigeon/entomologist/issues/4)
- [ ] [DB exporting and imporing](https://github.com/DisguisedPigeon/entomologist/issues/5)
- [ ] [Backend filtering and handling](https://github.com/DisguisedPigeon/entomologist/issues/7)
- [ ] [Frontend filtering and handling](https://github.com/DisguisedPigeon/entomologist/issues/6)
- [ ] [UPDATE README AS THINGS CHANGE](https://github.com/DisguisedPigeon/entomologist/issues/8) - this is important

## Usage

### Setup

```sh
gleam add entomologist
```

> [!IMPORTANT]
> Before using this library, you have to add this to your sql migrations.
> If you don't have any migration system, dbmate is a good option.

```sql
create type level as enum (
    'emergency',
    'alert',
    'critical',
    'error','Warning',
    'notice',
    'info',
    'debug'
);

create table if not exists errors (
    id bigserial not null unique primary key,
    message text not null,
    level level not null,
    module text not null,
    function text not null,
    arity int not null,
    file text not null,
    line int not null,
    resolved bool not null default false,
    last_occurrence bigint not null,
    snoozed bool not null default false
);

create table if not exists occurrences (
    id bigserial not null unique primary key,
    error bigint references errors(id) on delete cascade,
    timestamp bigint not null,
    full_contents json
    -- breadcrumbs
    --   This comes from elixir's Error Tracker. It's an infinite list of texts to help find the error. Might add it later.
);
```

### Usage overview

You should add the following line into your main function.
This saves the pog connection for later logging and registers the DB as a logging backend.

```gleam
let assert Ok(Nil) = entomologist.configure(connection)
```

From now on, every log generated by your gleam or erlang code will be saved to the database.

Entomologist also provides you with some utility functions to aid you with exception management through its api.

For more ergonomic but complex interactions, checkout [entomologist_extensions](https://www.github.com/DisguisedPigeon/entomologist-extensions)

Further documentation can be found at <https://hexdocs.pm/entomologist>.

## Development
> [!NOTE]
> To run the tests there must be a postgres database running on localhost with user and password "postgres" and database name "test".
> The port is read from the POSTGRES_PORT environment variable and if not present, 5431 (the default postgres port - 1) is used.
> The tables will be automatically created.

```sh
gleam test  # Run the tests (have you read the note?)
```

If you are confused about the emojis on the commits, check out <https://gitmoji.dev>

### For nix users

This repository counts with a `flake.nix` with gleam, gitmoji and watchexec

## Namesake
From wikipedia:
> Entomology \[...\] is the branch of zoology that focuses on insects. Those who study entomology are known as entomologists
